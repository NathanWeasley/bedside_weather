#include "led/led_driver.h"
#include <string.h>

static led_slice_t      g_led_tx_buf;
static led_breakdown_t  g_led_breakdown;

static uint16_t         g_weight_table[LED_COLOR_DEPTH];
static uint16_t         g_current_tick_count;
static uint8_t          g_current_bit;

static const uint16_t   g_img2buf_idx[LED_CNT] =
{
    0,  2,  2,  2,  2,  4,  4,  4,  4,  6,  6,  6,  6,  8,  8,  8,  8, 10, 10, 10, 10, 12, 12, 12, 12,
    0,  2,  2,  2,  2,  4,  4,  4,  4,  6,  6,  6,  6,  8,  8,  8,  8, 10, 10, 10, 10, 12, 12, 12, 12,
    0,  3,  3,  3,  3,  5,  5,  5,  5,  7,  7,  7,  7,  9,  9,  9,  9, 11, 11, 11, 11, 13, 13, 13, 13,
    0,  3,  3,  3,  3,  5,  5,  5,  5,  7,  7,  7,  7,  9,  9,  9,  9, 11, 11, 11, 11, 13, 13, 13, 13,
    0, 14, 14, 14, 14, 16, 16, 16, 16, 18, 18, 18, 18, 20, 20, 20, 20, 22, 22, 22, 22, 24, 24, 24, 24,
    0, 14, 14, 14, 14, 16, 16, 16, 16, 18, 18, 18, 18, 20, 20, 20, 20, 22, 22, 22, 22, 24, 24, 24, 24,
    0, 15, 15, 15, 15, 17, 17, 17, 17, 19, 19, 19, 19, 21, 21, 21, 21, 23, 23, 23, 23, 25, 25, 25, 25,
    0, 15, 15, 15, 15, 17, 17, 17, 17, 19, 19, 19, 19, 21, 21, 21, 21, 23, 23, 23, 23, 25, 25, 25, 25,
    1, 26, 26, 26, 26, 28, 28, 28, 28, 30, 30, 30, 30, 32, 32, 32, 32, 34, 34, 34, 34, 36, 36, 36, 36,
    1, 26, 26, 26, 26, 28, 28, 28, 28, 30, 30, 30, 30, 32, 32, 32, 32, 34, 34, 34, 34, 36, 36, 36, 36,
    1, 27, 27, 27, 27, 29, 29, 29, 29, 31, 31, 31, 31, 33, 33, 33, 33, 35, 35, 35, 35, 37, 37, 37, 37,
    1, 27, 27, 27, 27, 29, 29, 29, 29, 31, 31, 31, 31, 33, 33, 33, 33, 35, 35, 35, 35, 37, 37, 37, 37,
    1, 38, 38, 38, 38, 40, 40, 40, 40, 42, 42, 42, 42, 44, 44, 44, 44, 46, 46, 46, 46, 48, 48, 48, 48,
    1, 38, 38, 38, 38, 40, 40, 40, 40, 42, 42, 42, 42, 44, 44, 44, 44, 46, 46, 46, 46, 48, 48, 48, 48,
    1, 39, 39, 39, 39, 41, 41, 41, 41, 43, 43, 43, 43, 45, 45, 45, 45, 47, 47, 47, 47, 49, 49, 49, 49,
    1, 39, 39, 39, 39, 41, 41, 41, 41, 43, 43, 43, 43, 45, 45, 45, 45, 47, 47, 47, 47, 49, 49, 49, 49
};

static const uint16_t   g_img2buf_bit[LED_CNT] =
{
    0x80, 0x80, 0x40, 0x20, 0x10, 0x80, 0x40, 0x20, 0x10, 0x80, 0x40, 0x20, 0x10, 0x80, 0x40, 0x20, 0x10, 0x80, 0x40, 0x20, 0x10, 0x80, 0x40, 0x20, 0x10,
    0x40, 0x08, 0x04, 0x02, 0x01, 0x08, 0x04, 0x02, 0x01, 0x08, 0x04, 0x02, 0x01, 0x08, 0x04, 0x02, 0x01, 0x08, 0x04, 0x02, 0x01, 0x08, 0x04, 0x02, 0x01,
    0x20, 0x80, 0x40, 0x20, 0x10, 0x80, 0x40, 0x20, 0x10, 0x80, 0x40, 0x20, 0x10, 0x80, 0x40, 0x20, 0x10, 0x80, 0x40, 0x20, 0x10, 0x80, 0x40, 0x20, 0x10,
    0x10, 0x08, 0x04, 0x02, 0x01, 0x08, 0x04, 0x02, 0x01, 0x08, 0x04, 0x02, 0x01, 0x08, 0x04, 0x02, 0x01, 0x08, 0x04, 0x02, 0x01, 0x08, 0x04, 0x02, 0x01,
    0x08, 0x80, 0x40, 0x20, 0x10, 0x80, 0x40, 0x20, 0x10, 0x80, 0x40, 0x20, 0x10, 0x80, 0x40, 0x20, 0x10, 0x80, 0x40, 0x20, 0x10, 0x80, 0x40, 0x20, 0x10,
    0x04, 0x08, 0x04, 0x02, 0x01, 0x08, 0x04, 0x02, 0x01, 0x08, 0x04, 0x02, 0x01, 0x08, 0x04, 0x02, 0x01, 0x08, 0x04, 0x02, 0x01, 0x08, 0x04, 0x02, 0x01,
    0x02, 0x80, 0x40, 0x20, 0x10, 0x80, 0x40, 0x20, 0x10, 0x80, 0x40, 0x20, 0x10, 0x80, 0x40, 0x20, 0x10, 0x80, 0x40, 0x20, 0x10, 0x80, 0x40, 0x20, 0x10,
    0x01, 0x08, 0x04, 0x02, 0x01, 0x08, 0x04, 0x02, 0x01, 0x08, 0x04, 0x02, 0x01, 0x08, 0x04, 0x02, 0x01, 0x08, 0x04, 0x02, 0x01, 0x08, 0x04, 0x02, 0x01,
    0x80, 0x80, 0x40, 0x20, 0x10, 0x80, 0x40, 0x20, 0x10, 0x80, 0x40, 0x20, 0x10, 0x80, 0x40, 0x20, 0x10, 0x80, 0x40, 0x20, 0x10, 0x80, 0x40, 0x20, 0x10,
    0x40, 0x08, 0x04, 0x02, 0x01, 0x08, 0x04, 0x02, 0x01, 0x08, 0x04, 0x02, 0x01, 0x08, 0x04, 0x02, 0x01, 0x08, 0x04, 0x02, 0x01, 0x08, 0x04, 0x02, 0x01,
    0x20, 0x80, 0x40, 0x20, 0x10, 0x80, 0x40, 0x20, 0x10, 0x80, 0x40, 0x20, 0x10, 0x80, 0x40, 0x20, 0x10, 0x80, 0x40, 0x20, 0x10, 0x80, 0x40, 0x20, 0x10,
    0x10, 0x08, 0x04, 0x02, 0x01, 0x08, 0x04, 0x02, 0x01, 0x08, 0x04, 0x02, 0x01, 0x08, 0x04, 0x02, 0x01, 0x08, 0x04, 0x02, 0x01, 0x08, 0x04, 0x02, 0x01,
    0x08, 0x80, 0x40, 0x20, 0x10, 0x80, 0x40, 0x20, 0x10, 0x80, 0x40, 0x20, 0x10, 0x80, 0x40, 0x20, 0x10, 0x80, 0x40, 0x20, 0x10, 0x80, 0x40, 0x20, 0x10,
    0x04, 0x08, 0x04, 0x02, 0x01, 0x08, 0x04, 0x02, 0x01, 0x08, 0x04, 0x02, 0x01, 0x08, 0x04, 0x02, 0x01, 0x08, 0x04, 0x02, 0x01, 0x08, 0x04, 0x02, 0x01,
    0x02, 0x80, 0x40, 0x20, 0x10, 0x80, 0x40, 0x20, 0x10, 0x80, 0x40, 0x20, 0x10, 0x80, 0x40, 0x20, 0x10, 0x80, 0x40, 0x20, 0x10, 0x80, 0x40, 0x20, 0x10,
    0x01, 0x08, 0x04, 0x02, 0x01, 0x08, 0x04, 0x02, 0x01, 0x08, 0x04, 0x02, 0x01, 0x08, 0x04, 0x02, 0x01, 0x08, 0x04, 0x02, 0x01, 0x08, 0x04, 0x02, 0x01
};

void led_init()
{
    uint16_t i;

    /** Initializing global variables */

    g_led_tx_buf.head = g_led_tx_buf.data;
    g_led_tx_buf.mid = g_led_tx_buf.head + LED_BUFFER_SIZE/2;

    memset(&g_led_breakdown, 0xFF, sizeof(g_led_breakdown));
    for (i = 0; i < LED_COLOR_DEPTH; ++i)
    {
        g_led_breakdown.slice[i].head = g_led_breakdown.slice[i].data;
        g_led_breakdown.slice[i].mid = g_led_breakdown.slice[i].head + LED_BUFFER_SIZE/2;
    }

    for (i = 0; i < LED_COLOR_DEPTH; ++i)
    {
        g_weight_table[i] = 1 << (LED_COLOR_DEPTH - 1 -i);
    };

    g_current_bit = 0;
    g_current_tick_count = 0;

    /** Copy first slice */

    memcpy(g_led_tx_buf.head, g_led_breakdown.slice[0].head, LED_BUFFER_SIZE);
}

void led_update_img(const uint8_t * pdata)
{
    uint8_t i, mask;
    uint16_t j;
    uint8_t * slice_ptr;
    const uint8_t * img_ptr;

    for (i = 0; i < LED_COLOR_DEPTH; ++i)
    {
        mask = 1 << (LED_COLOR_DEPTH - 1 -i);
        slice_ptr = g_led_breakdown.slice[i].head;
        img_ptr = pdata;

        ///< memset here will cause flicker
        // memset(slice_ptr, 0xFF, LED_BUFFER_SIZE);

        for (j = 0; j < LED_CNT; ++j, ++img_ptr)
        {
            if (*img_ptr & mask)
            {
                slice_ptr[g_img2buf_idx[j]] &= ~g_img2buf_bit[j];
            }
            else
            {
                slice_ptr[g_img2buf_idx[j]] |= g_img2buf_bit[j];
            }
        }
    }
}

uint32_t led_get_txbuf_addr()
{
    return (uint32_t)g_led_tx_buf.head;
}

uint32_t led_get_txbuf_size()
{
    return LED_BUFFER_SIZE;
}

void led_copy_first_half()
{
    memcpy(g_led_tx_buf.head, g_led_breakdown.slice[g_current_bit].head, LED_BUFFER_SIZE/2);
}

void led_copy_last_half()
{
    memcpy(g_led_tx_buf.mid, g_led_breakdown.slice[g_current_bit].mid, LED_BUFFER_SIZE/2);
}

void led_next_tick()
{
    if (++g_current_tick_count == g_weight_table[g_current_bit])
    {
        g_current_tick_count = 0;
        if (++g_current_bit == LED_COLOR_DEPTH)
        {
            g_current_bit = 0;
        }
    }
}
